# 工程开发环境
**集成开发环境** STM32CubeIDE
**外部库函数**  STM32标准库 V3.6.1


# 目录结构

目录设计目的是方便移植功能到不同的芯片、不同的嵌入式系统上，采用分层设计，使用芯片提供的HAL层及时间片，虚拟设备层用于实现硬件强关联及实时性，数据分发层通过中断及缓冲实现快速通讯流处理，配置用于实现整个独立设备及组合设备的通道分配及功能复合，协议层用于实现对控制数据的解析功能，最终达到子设备与子设备解耦，设备与协议解耦，协议与管道解耦的效果。

一个设备产品，除了系统时钟作为基础定时器等功能外，需要在虚拟设备层、配置层、协议层及管道层上实现具体功能，形成一个完成的设备功能，组合设备通过组合每个子设备的功能，分配通道地址，实现组合设备的功能及实时性。本模板以面向接口和面向协议的编程思想，在满足嵌入式系统高实时性要求下，以通道概念组织设备功能及数据流分发，子设备各模块功能间也以流处理协调各个模块功能，优先保证通讯实时性及虚拟设备模拟硬件逻辑的实时性，以保证设备正常、快速运行。

## 1 .vscode

项目编辑器配置目录

## 2 USER

目录具体根据所使用的编译器决定

### 2.1 main.c/main.cpp

引导层，系统程序入口

### 2.2 sys_device

系统设备层，系统级硬件，主循环协程/嵌入式系统线程，包括通用定时器、时钟初始化、主中断等，该设备初始化并运行后，系统基本功能运行，允许其他虚拟设备初始化及运行

### 2.3 virtual_device

虚拟设备层，通过使用单片机片内外设(HAL)，通用实时定时器/通用非实时定时器，主循环协程/线程(sys_device)，实现具体设备硬件基础功能，并提供安全的和读取状态接口，如数码管显示、带渐变的LED控制等

## 2.4 exchange

数据流交互组件，如CAN通讯、串口通讯、数码管显示、键盘等

## 2.5 config_device

配置设备层，通过宏定义、常量表、变量表等数据，分配通道，规划通道映射，设置保存参数，组合通道、子设备组件、参数、数据流交换组件，形成一个完成的设备功能

## 2.6 protocol

协议层，接收来自channel层的数据流，实现每个子设备协议分析和处理

## 2.7 channel

管道层，以配置设备层的通道分配，分发通讯接口的数据流，传递到协议层解析，主要针对CAN接口数据处理

## 2.8 tools

调试工具，如printf、ST-Link、数据分析接口等，需要调试用的虚拟硬件层支持

## 2.9 common

常用函数工具，如粗延时，数学函数，JSON解析等于基本与硬件没有关系的通用函数

## 2.10 user_hal

芯片HAL层，大部分有芯片项目模板提供，可缺省

## 2.11 third_protocol_dev

通过第三方协议的虚拟设备，一般为TTL/485/RS232等设备，需要调用channel中的串口通道设备

## 3 其他目录

有部分项目描述文件，其他目录有具体编译器决定

STM32CubeIDE /Core/Inc项目中的公共头文件，如通用类型定义文件，存放于该目录

api_doc，协议文档、接口文档、项目结构说明、框架说明等

# 4 版本说明

本实例为基于STM32的DMX512网关，模板可适用于8/32位单片机(8位单片机用IAR，32位单片机用eclipse同族IDE),IDE需要支持多级文件目录，no OS or freertos上应用，对大部分freertos，实时模块需要斟酌使用，非实时任务采用线程方式调度即可。